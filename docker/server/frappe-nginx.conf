# docker/server/frappe-nginx.conf
# Frappe bench nginx config — déployée par entrypoint.sh
# Sert les assets statiques + proxie les requêtes dynamiques vers gunicorn :8001
# Note: Le chemin du bench est découvert dynamiquement à l'entrypoint

upstream frappe_gunicorn {
    server 127.0.0.1:8001 fail_timeout=0;
    keepalive 8;
}

# Map to handle real IP behind Traefik
map $http_x_forwarded_for $real_ip {
    default $remote_addr;
    "~^(?P<firstip>[^,]+)" $firstip;
}

server {
    listen 80;
    server_name *.press.local press.local _;

    # Root dynamique — remplacé par entrypoint.sh via sed
    root BENCH_SITES_PATH;

    # Logging
    access_log /var/log/nginx/frappe-bench.access.log;
    error_log  /var/log/nginx/frappe-bench.error.log;

    # Security headers
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # Proxy headers (Traefik forwards HTTPS)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $real_ip;
    proxy_set_header X-Forwarded-For $http_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-Host $host;

    # ── Static assets (shared across all sites in the bench) ─────────────────
    location /assets {
        alias BENCH_ASSETS_PATH;
        add_header Cache-Control "no-cache, must-revalidate";
        expires 1h;
        try_files $uri =404;
    }

    # ── Site-specific files (public uploads) ──────────────────────────────────
    location ~ ^/sites/(.+)/public/(.*)$ {
        alias BENCH_SITES_PATH/$1/public/$2;
        expires 1h;
        try_files $uri =404;
    }

    # Short URL for files (frappe generates these URLs)
    location /files {
        try_files /sites/$host/public/files/$uri /sites/$host/private/files/$uri @gunicorn;
    }

    # ── Error snapshots ───────────────────────────────────────────────────────
    location /error-snapshots {
        root BENCH_SITES_PATH;
        try_files $uri =404;
    }

    # ── Frappe logos and other root static files ──────────────────────────────
    location = /favicon.ico {
        root BENCH_SITES_PATH;
        try_files /assets/frappe/images/favicon.png =404;
    }

    # ── All other requests → Gunicorn ─────────────────────────────────────────
    location / {
        try_files $uri @gunicorn;
    }

    location @gunicorn {
        proxy_pass http://frappe_gunicorn;
        proxy_read_timeout    120;
        proxy_connect_timeout 10;
        proxy_send_timeout    120;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_ip;
        proxy_set_header X-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;
    }

    # ── Deny access to private files served directly ──────────────────────────
    location ~ ^/sites/.+/private/ {
        return 403;
    }
}
