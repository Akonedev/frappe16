# config/traefik/dynamic/client-sites.yml
# Routes Traefik pour les sites clients Frappe gérés par Press
# Ce fichier est rechargé automatiquement (watch: true)
# Ajouter une entrée par site client créé

http:
  routers:
    # Route wildcard pour tous les sous-domaines *.press.local → nginx du server container
    # Traefik v3 supporte le wildcard Host nativement
    client-sites:
      rule: "HostRegexp(`^[a-z0-9-]+\\.press\\.local$`)"
      entryPoints:
        - websecure
      service: frappe-server
      tls: {}
      priority: 1

    # Route press.local → nginx du container press (priorité max pour éviter capture par wildcard)
    press-admin:
      rule: "Host(`press.local`)"
      entryPoints:
        - websecure
      service: press-admin-nginx
      tls: {}
      priority: 100

  services:
    # Service backend : nginx dans le container server (port 80)
    # Nginx sert les assets statiques directement et proxifie vers gunicorn (8001)
    frappe-server:
      loadBalancer:
        servers:
          - url: "http://presse_claude_server:80"
        passHostHeader: true

    # Service press admin : gunicorn dans le container press (port 8000)
    press-admin-nginx:
      loadBalancer:
        servers:
          - url: "http://presse_claude_press:8000"
        passHostHeader: true
